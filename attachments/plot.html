<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>Philadelphia :: Plot</title>
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.couch.js?0.9.0"></script> 
    <script language="javascript" type="text/javascript" src="js/jquery.flot.min.js"></script>
    <link type="text/css" rel="stylesheet" href="css/boxy.css">
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <link type="text/css" rel="stylesheet" href="css/jquery-ui-1.8.16.custom.css"/>
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Sans"/>
    <style>
      input {border: solid 1px black; background: #eee; }
      button {border: solid 1px black; background: #eee; }
      button.good { background: #90ee90; }
      button.bad { background: pink; }
      button.big { padding: 4px; font-size: medium; font-weight: bold }
    </style>
  </head>
  <body>
    <!-- begin header //-->
    <div id="header">
      <div id="branding">
        <a href="index.html" class="header"><h1 id="site-name">Philadelphia</h1></a>
      </div>
    </div>
    <br/>
    <!-- end header //-->

    <!-- begin content //-->
    <div id="content">

      <!-- begin plot area //-->
      <div style="float:left;width:73%;padding-left:10px">
        <div class="ui-widget-header">Plot</div>
        <div id="tabs">
          <ul>
            <li style="font-size:small;"><a id="tab_scatter" href="#tabs-1">Scatter Plot</a></li>
            <li style="font-size:small;"><a id="tab_timeseries" href="#tabs-2">Time Series</a></li>
            <li style="font-size:small;"><a id="tab_histogram" href="#tabs-3">Histogram</a></li>
          </ul>
          <div id="tabs-1">
            <!-- begin scatter plot //-->
            <div id="plot_scatter" class="ui-widget-content" style="width:600px;height:300px;border:dashed 1px black;background:#f1f1f1;"></div>
            <br/>
            <form action="">
              <table>
                <tr>
                  <td style="width:75px"><label for="xkey_scatter">x series</label></td>
                  <td style="width:300px"><input type="text" tabindex=1 class="ui-autocomplete-input autokeys" id="xval_scatter"/></td>
                  <td rowspan=2 style="width:125px">
                    <button tabindex=3 style="" id="makeplot_scatter" class="big">Plot</button>
                  </td>
                  <td rowspan=2 style="width:auto">
                    <div id="scatter_alert" class="ui-widget" style="display:none;font-size:medium">
                      <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"> 
                        <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span> 
                        <strong>Alert:</strong> Could not convert some values to numbers.</p>
                      </div>

                    </div>
                  </td>
                </tr>
                <tr>
                  <td><label for="ykey_scatter">y series</label></td>
                  <td><input type="text" tabindex=2 class="ui-autocomplete-input autokeys" id="yval_scatter"/></td>
                </tr>
              </table>
            </form>
            <!-- end scatter plot //-->
          </div>
          <div id="tabs-2">
            <!-- begin time series plot //-->
            <div id="plot_timeseries" class="ui-widget-content" style="width:600px;height:300px;border:dashed 1px black;background:#f1f1f1;"></div>
            <br/>
            <form action="">
              <table>
                <tr>
                  <td style="width:75px"><label for="ykey_timeseries">Series</label></td>
                  <td style="width:300px"><input type="text" tabindex=1 class="ui-autocomplete-input autokeys" id="yval_timeseries"/></td>
                  <td style="width:125px">
                    <button tabindex=2 id="makeplot_timeseries" class="big">Plot</button>
                  </td>
                  <td style="width:auto">
                    <div id="timeseries_alert" class="ui-widget" style="display:none;font-size:medium">
                      <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"> 
                        <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span> 
                        <strong>Alert:</strong> Could not convert some values to numbers.</p>
                      </div>

                    </div>
                  </td>
                </tr>
              </table>
            </form>
            <!-- end time series plot //-->
          </div>
          <div id="tabs-3">
            <!-- begin histogram //-->
            <div id="plot_histogram" class="ui-widget-content" style="width:600px;height:300px;border:dashed 1px black;background:#f1f1f1;"></div>
            <br/>
            <form action="">
              <table>
                <tr>
                  <td style="width:75px"><label for="series_histogram">Series</label></td>
                  <td style="width:300px"><input type="text" tabindex=1 class="ui-autocomplete-input autokeys" id="series_histogram"/></td>
                  <td rowspan=2 style="width:125px">
                    <button tabindex=3 style="" id="makeplot_histogram" class="big">Plot</button>
                  </td>
                  <td rowspan=2 style="width:auto">
                    <div id="histogram_alert" class="ui-widget" style="display:none;font-size:medium">
                      <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"> 
                        <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span> 
                        <strong>Alert:</strong> Could not convert some values to numbers.</p>
                      </div>

                    </div>
                  </td>
                </tr>
                <tr>
                  <td><label for="nbins_histogram">Number of bins</label></td>
                  <td><input type="text" tabindex=2 class="ui-autocomplete-input" id="nbins_histogram"/></td>
                </tr>
              </table>
            </form>
            <!-- end scatter plot //-->
          </div>
        </div>
      </div>
      <!-- end plot area //-->

      <!-- begin footer //-->
      <div style="font-size:xx-small;float:right;padding-right:3em">
        <dl>
          <dt><b>Philadelphia,</b></dt>
          <dd><a href="https://github.com/mastbaum/philadelphia">Source on github</a></dd>
          <dd><a href="https://github.com/mastbaum/philadelphia/issues">Report a bug</a></dd>
          <dd>&nbsp;</dd>
          <dd><a href="mailto:mastbaum@hep.upenn.edu">Andy Mastbaum</a></dd>
          <dd>The University of Pennsylvania</dd>
        </dl>
      </div>
      <!-- end footer //-->

    </div>
    <!-- end content //-->

  </body>

  <script>
    function getParameterByName(name)
    {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regexS = "[\\?&]" + name + "=([^&#]*)";
      var regex = new RegExp(regexS);
      var results = regex.exec(window.location.href);
      if(results == null)
      return "";
      else
      return decodeURIComponent(results[1].replace(/\+/g, " "));
    }


    // todo: add date ranges
    function getSeriesData(key) {
      var vals = [];
      $.ajax("/phila/_design/phila/_view/all_keys", {
        dataType: 'json',
        async: false,
        data: 'startkey=["'+key+'"]&endkey=["'+key+'",{}]',
        success: function(data) {
          for (i in data.rows) {
            var val = data.rows[i].value;
            vals.push(val);
          }
        }
      });
      return(vals);
    }

    function histogram(data, nbins) {
      var min = Math.min.apply(Math, data);
      var max = Math.max.apply(Math, data);
      var width = (max - min + 1) / nbins;

      var bins = [];
      for (var i = 0; i < nbins; i++) {
        var leftEdge = min + i * width;
        bins.push({
          leftEdge: leftEdge,
          count: 0
        });
      }

      for (i = 0; i < data.length; i++) {
        for (var j = 0; j < nbins; j++) {
          if (data[i] >= bins[j].leftEdge && (bins[j+1] ? data[i] < bins[j+1].leftEdge : data[i] <= max)) {
            bins[j].count++;
          }
        }
      }

      var hist = [];
      for (i = 0; i < bins.length; i++) {
        hist.push([bins[i].leftEdge, bins[i].count]);
      }
      return hist;
    }

    function getAutocompleteKeyList() {
      var keys = [];
      $.ajax("/phila/_design/phila/_view/keylist", {
        dataType: 'json',
        async: false,
        data: 'group=true',
        success: function(data) {
          for (i in data.rows)  {
            keys.push(data.rows[i].key);
          }
        }
      });
      return(keys);
    }

    $(document).ready(function() {
      $db = $.couch.db("phila");
      var keys = getAutocompleteKeyList();
      $("input.autokeys").autocomplete({source: keys, delay: 0});
      $("#tabs").tabs();
      $("#xval_scatter").focus();
    });

    $("a#tab_scatter").live('click', function() {
      $("#xval_scatter").focus();
    });

    $("a#tab_timeseries").live('click', function() {
      $("#yval_timeseries").focus();
    });

    $("a#tab_histogram").live('click', function() {
      $("#yval_histogram").focus();
    });

    // scatter plot
    $("button#makeplot_scatter").live('click', function(event) {
      event.preventDefault();
      field_x = $("input#xval_scatter").val();
      x = getSeriesData(field_x).map(parseFloat);
      field_y = $("input#yval_scatter").val();
      y = getSeriesData(field_y).map(parseFloat);
      var plot_data = [];
      var nans = false;
      for (var i=0; i<Math.min(x.length, y.length); i++) {
        if (!isNaN(x[i]) && !isNaN(y[i])) {
          plot_data.push([x[i], y[i]]);
        }
        else {
          nans = true;
        }
        if (nans) {
          $("#scatter_alert").fadeIn('slow');
        }
        else {
          $("#scatter_alert").fadeOut('slow');
        }
      }
      $.plot($("#plot_scatter"), [plot_data], {lines: {show: false}, points: {show: true}});
    });

    // time series
    $("button#makeplot_timeseries").live('click', function(event) {
      event.preventDefault();
      var key = $("input#yval_timeseries").val();
      var vals = [];
      $.ajax("/phila/_design/phila/_view/all_keys", {
        dataType: 'json',
        async: false,
        data: 'startkey=["'+key+'"]&endkey=["'+key+'",{}]',
        success: function(data) {
          var nans = false;
          for (i in data.rows) {
            var val = data.rows[i].value;
            if (!isNaN(val)) {
              var time = Date.parse(data.rows[i].key[1]);
              vals.push([time, val]);
            }
            else {
              nans = true;
            }
          }
          if (nans) {
            $("#timeseries_alert").fadeIn('slow');
          }
          else {
            $("#timseries_alert").fadeOut('slow');
          }
          $.plot($("#plot_timeseries"), [vals], {xaxis: {mode: "time"}});
        }
      });
    });

    // histogram
    $("button#makeplot_histogram").live('click', function(event) {
      event.preventDefault();
      var key = $("input#series_histogram").val();
      var nbins = $("input#nbins_histogram").val();
      var vals = [];
      $.ajax("/phila/_design/phila/_view/all_keys", {
        dataType: 'json',
        async: false,
        data: 'startkey=["'+key+'"]&endkey=["'+key+'",{}]',
        success: function(data) {
          var nans = false;
          for (i in data.rows) {
            var val = data.rows[i].value;
            if (!isNaN(val)) {
              var time = Date.parse(data.rows[i].key[1]);
              vals.push(val);
            }
            else {
              nans = true;
            }
          }
          if (nans) {
            $("#histogram_alert").fadeIn('slow');
          }
          else {
            $("#histogram_alert").fadeOut('slow');
          }
          var min = Math.min.apply(Math, vals);
          var max = Math.max.apply(Math, vals);
          var width = (max - min + 1) / nbins;

          var hist = histogram(vals, nbins);

          $.plot($("#plot_histogram"), [hist], {
            series: {
              stack: 0,
              lines: { show: false, fill: true, steps: false },
              bars: { show: true, barWidth: width }
            }
          });
        }
      });
    });

  </script>

</html>

