<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>Philadelphia :: Plot</title>
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.couch.js?0.9.0"></script> 
    <script language="javascript" type="text/javascript" src="js/jquery.flot.min.js"></script>
    <link type="text/css" rel="stylesheet" href="css/boxy.css">
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <link type="text/css" rel="stylesheet" href="css/jquery-ui-1.8.16.custom.css"/>
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Sans"/>
    <style>
      input {border: solid 1px black; background: #eee; }
      button {border: solid 1px black; background: #eee; }
      button.good { background: #90ee90; }
      button.bad { background: pink; }
      button.big { padding: 4px; font-size: medium; font-weight: bold }
    </style>
  </head>
  <body>
    <!-- begin header //-->
    <div id="header">
      <div id="branding">
        <a href="index.html" class="header"><h1 id="site-name">Philadelphia</h1></a>
      </div>
    </div>
    <br/>
    <!-- end header //-->

    <!-- begin content //-->
    <div id="content">

      <!-- begin plot area //-->
      <div style="float:left;width:73%;padding-left:10px">
        <div class="ui-widget-header">Plot</div>
        <div id="tabs">
          <ul>
            <li><a href="#tabs-1">Scatter Plot</a></li>
            <li><a href="#tabs-2">Time Series</a></li>
            <li><a href="#tabs-3">Histogram</a></li>
          </ul>
          <div id="tabs-1">
            <div id="plot_scatter" class="ui-widget-content" style="width:600px;height:300px;border:dashed 1px black;background:#f1f1f1;"></div>
            <br/>
            <div id="scatter_alert" class="ui-widget" style="display:none;font-size:medium">
              <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"> 
                <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span> 
                <strong>Alert:</strong> Could not convert some values to numbers.</p>
              </div>
            </div>
            <form action="">
              <label for="xkey_scatter">x series</label>&nbsp;<input type="text" class="ui-autocomplete-input autokeys" id="xval_scatter"/><br/>
              <label for="ykey_scatter">y series</label>&nbsp;<input type="text" class="ui-autocomplete-input autokeys" id="yval_scatter"/><br/>
              <button style="margin-left:200px" id="makeplot_scatter" class="big">Plot</button>
            </form>
          </div>
          <div id="tabs-2">
            Time series
          </div>
          <div id="tabs-3">
            Histogram
          </div>
        </div>
      </div>
      <!-- end plot area //-->

      <!-- begin footer //-->
      <div style="font-size:xx-small;float:right;padding-right:3em">
        <dl>
          <dt><b>Philadelphia,</b></dt>
          <dd><a href="https://github.com/mastbaum/philadelphia">Source on github</a></dd>
          <dd><a href="https://github.com/mastbaum/philadelphia/issues">Report a bug</a></dd>
          <dd>&nbsp;</dd>
          <dd><a href="mailto:mastbaum@hep.upenn.edu">Andy Mastbaum</a></dd>
          <dd>The University of Pennsylvania</dd>
        </dl>
      </div>
      <!-- end footer //-->

    </div>
    <!-- end content //-->

  </body>

  <script>
    function getParameterByName(name)
    {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regexS = "[\\?&]" + name + "=([^&#]*)";
      var regex = new RegExp(regexS);
      var results = regex.exec(window.location.href);
      if(results == null)
      return "";
      else
      return decodeURIComponent(results[1].replace(/\+/g, " "));
    }


    // todo: add date ranges
    function getSeriesData(key) {
      var vals = [];
      $.ajax("/phila/_design/phila/_view/all_keys", {
        dataType: 'json',
        async: false,
        data: 'startkey=["'+key+'"]&endkey=["'+key+'",{}]',
        success: function(data) {
          for (i in data.rows) {
            var val = data.rows[i].value;
            vals.push(val);
          }
        }
      });
      return(vals);
    }

    function getAutocompleteKeyList() {
      var keys = [];
      $.ajax("/phila/_design/phila/_view/keylist", {
        dataType: 'json',
        async: false,
        data: 'group=true',
        success: function(data) {
          for (i in data.rows)  {
            keys.push(data.rows[i].key);
          }
        }
      });
      return(keys);
    }

    $(document).ready(function() {
      $db = $.couch.db("phila");
      var keys = getAutocompleteKeyList();
      $("input.autokeys").autocomplete({source: keys});
      $("#tabs").tabs();
    });

    // scatter plot
    $("button#makeplot_scatter").live('click', function(event) {
      event.preventDefault();
      field_x = $("input#xval_scatter").val();
      x = getSeriesData(field_x).map(parseFloat);
      field_y = $("input#yval_scatter").val();
      y = getSeriesData(field_y).map(parseFloat);
      var plot_data = [];
      var nans = false;
      for (var i=0; i<Math.min(x.length, y.length); i++) {
        if (!isNaN(x[i]) && !isNaN(y[i]))
          plot_data.push([x[i], y[i]]);
        else
          nans = true;
        if (nans)
        $("#scatter_alert").fadeIn('slow');
        else
        $("#scatter_alert").fadeOut('slow');
      }
      $.plot($("#plot_scatter"), [plot_data]);
    });

  </script>

</html>

