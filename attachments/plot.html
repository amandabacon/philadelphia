<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>Philadelphia / Plot</title>
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.js"></script> 
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery.flot.min.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.couch.js?0.9.0"></script> 
    <link type="text/css" rel="stylesheet" href="css/tablesorter.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap.css"/>
  </head>
  <body>
    <!-- begin header //-->
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container" style="margin-left:0px">
          <a class="brand" href="index.html">Philadelphia</a>
          <ul class="nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="edit.html">New</a></li>
            <li class="active"><a href="#">Plot</a></li>
          </ul>
        </div>
      </div>
    </div>
    <!-- end header //-->

    <!-- begin content //-->
    <div id="content">
      <div class="container-fluid">

        <!-- begin plot area //-->
        <div class="row-fluid">
          <div class="span10">
            <h1>Plot</h1>
            <div class="tabbable">
              <ul class="nav nav-tabs">
                <li class="active"><a href="#tab-scatter" data-toggle="tab">Scatter</a></li>
                <li><a href="#tab-series" data-toggle="tab">Time Series</a></li>
                <li><a href="#tab-histogram" data-toggle="tab">Histogram</a></li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane active" id="tab-scatter">
                  <!-- begin scatter plot //-->
                  <div id="plot_scatter" class="ui-widget-content" style="width:600px;height:300px;border:dashed 1px black;background:#f1f1f1;"></div>
                  <br/>
                  <form action="">
                    <table>
                      <tr>
                        <td style="width:75px"><label for="xkey_scatter">x series</label></td>
                        <td style="width:300px"><input type="text" tabindex=1 class="ui-autocomplete-input autokeys" id="xval_scatter"/></td>
                        <td rowspan=2 style="width:125px">
                          <button tabindex=3 style="" id="makeplot_scatter" class="big">Plot</button>
                        </td>
                        <td rowspan=2 style="width:auto">
                          <div id="scatter_alert" class="ui-widget" style="display:none;font-size:medium">
                            <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"> 
                              <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span> 
                              <strong>Alert:</strong> Could not convert some values to numbers.</p>
                            </div>

                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td><label for="ykey_scatter">y series</label></td>
                        <td><input type="text" tabindex=2 class="ui-autocomplete-input autokeys" id="yval_scatter"/></td>
                      </tr>
                    </table>
                  </form>
                  <!-- end scatter plot //-->
                </div>
                <div class="tab-pane" id="tab-series">
                  <!-- begin time series plot //-->
                  <div id="plot_timeseries" class="ui-widget-content" style="width:600px;height:300px;border:dashed 1px black;background:#f1f1f1;"></div>
                  <br/>
                  <form action="">
                    <table>
                      <tr>
                        <td style="width:75px"><label for="ykey_timeseries">Series</label></td>
                        <td style="width:300px"><input type="text" tabindex=1 class="ui-autocomplete-input autokeys" id="yval_timeseries"/></td>
                        <td style="width:125px">
                          <button tabindex=2 id="makeplot_timeseries" class="big">Plot</button>
                        </td>
                        <td style="width:auto">
                          <div id="timeseries_alert" class="ui-widget" style="display:none;font-size:medium">
                            <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"> 
                              <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span> 
                              <strong>Alert:</strong> Could not convert some values to numbers.</p>
                            </div>

                          </div>
                        </td>
                      </tr>
                    </table>
                  </form>
                  <!-- end time series plot //-->
                </div>
                <div class="tab-pane" id="tab-histogram">
                  <!-- begin histogram //-->
                  <div id="plot_histogram" class="ui-widget-content" style="width:600px;height:300px;border:dashed 1px black;background:#f1f1f1;"></div>
                  <br/>
                  <form action="">
                    <table>
                      <tr>
                        <td style="width:75px"><label for="series_histogram">Series</label></td>
                        <td style="width:300px"><input type="text" tabindex=1 class="ui-autocomplete-input autokeys" id="series_histogram"/></td>
                        <td rowspan=2 style="width:125px">
                          <button tabindex=3 style="" id="makeplot_histogram" class="big">Plot</button>
                        </td>
                        <td rowspan=2 style="width:auto">
                          <div id="histogram_alert" class="ui-widget" style="display:none;font-size:medium">
                            <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"> 
                              <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span> 
                              <strong>Alert:</strong> Could not convert some values to numbers.</p>
                            </div>

                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td><label for="nbins_histogram"># of bins</label></td>
                        <td><input type="text" tabindex=2 class="ui-autocomplete-input" id="nbins_histogram"/></td>
                      </tr>
                    </table>
                  </form>
                  <!-- end scatter plot //-->
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- end plot area //-->

        <!-- begin footer //-->
        <div class="row-fluid">
          <div class="span10">
            <div class="well" style="padding:5px">
              <div class="row">
                <div class="span2">
                  <h3>Philadelphia 0.8</h3>
                </div>
                <div class="span1">
                  <a href="https://github.com/mastbaum/philadelphia">Source</a>
                </div>
                <div class="span1">
                  <a href="https://github.com/mastbaum/philadelphia/issues">Bugs</a>
                </div>
                <div class="span3 offset5">
                  <a href="mailto:mastbaum@hep.upenn.edu">Andy Mastbaum</a><br/>The University of Pennsylvania
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- end footer //-->

      </div>
    </div>
    <!-- end content //-->

  </body>

  <script>
    function getParameterByName(name)
    {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regexS = "[\\?&]" + name + "=([^&#]*)";
      var regex = new RegExp(regexS);
      var results = regex.exec(window.location.href);
      if(results == null)
      return "";
      else
      return decodeURIComponent(results[1].replace(/\+/g, " "));
    }


    // todo: add date ranges
    function getSeriesData(key) {
      var vals = [];
      $.ajax("/phila/_design/phila/_view/all_keys", {
        dataType: 'json',
        async: false,
        data: 'startkey=["'+key+'"]&endkey=["'+key+'",{}]',
        success: function(data) {
          for (i in data.rows) {
            var val = data.rows[i].value;
            vals.push({report_id: 0, value: val});
          }
        }
      });
      return(vals);
    }

    function histogram(data, nbins) {
      var min = Math.min.apply(Math, data);
      var max = Math.max.apply(Math, data);
      var width = (max - min + 1) / nbins;

      var bins = [];
      for (var i = 0; i < nbins; i++) {
        var leftEdge = min + i * width;
        bins.push({
          leftEdge: leftEdge,
          count: 0
        });
      }

      for (i = 0; i < data.length; i++) {
        for (var j = 0; j < nbins; j++) {
          if (data[i] >= bins[j].leftEdge && (bins[j+1] ? data[i] < bins[j+1].leftEdge : data[i] <= max)) {
            bins[j].count++;
          }
        }
      }

      var hist = [];
      for (i = 0; i < bins.length; i++) {
        hist.push([bins[i].leftEdge, bins[i].count]);
      }
      return hist;
    }

    function getAutocompleteKeyList() {
      var keys = [];
      $.ajax("/phila/_design/phila/_view/keylist", {
        dataType: 'json',
        async: false,
        data: 'group=true',
        success: function(data) {
          for (i in data.rows)  {
            keys.push(data.rows[i].key);
          }
        }
      });
      return(keys);
    }

    $(document).ready(function() {
      $db = $.couch.db("phila");
      var keys = getAutocompleteKeyList();
      $("input.autokeys").autocomplete({source: keys, delay: 0});
      $("#tabs").tabs();
      $("#xval_scatter").focus();
    });

    $("#tabs").css("width", $(".ui-widget-header").width());

    $("a#tab_scatter").live('click', function() {
      $("#xval_scatter").focus();
    });

    $("a#tab_timeseries").live('click', function() {
      $("#yval_timeseries").focus();
    });

    $("a#tab_histogram").live('click', function() {
      $("#yval_histogram").focus();
    });

    // scatter plot
    $("button#makeplot_scatter").live('click', function(event) {
      event.preventDefault();
      field_x = $("input#xval_scatter").val();
      xdata = getSeriesData(field_x).map(parseFloat);
      field_y = $("input#yval_scatter").val();
      ydata = getSeriesData(field_y).map(parseFloat);
      var plot_data = [];
      var nans = false;
      for (var i=0; i<Math.min(x.length, y.length); i++) {
        if (!isNaN(x[i]) && !isNaN(y[i])) {
          plot_data.push([x[i], y[i]]);
        }
        else {
          nans = true;
        }
        if (nans) {
          $("#scatter_alert").fadeIn('slow');
        }
        else {
          $("#scatter_alert").fadeOut('slow');
        }
      }
      $.plot($("#plot_scatter"), [plot_data], {lines: {show: false}, points: {show: true}});
    });

    // time series
    $("button#makeplot_timeseries").live('click', function(event) {
      event.preventDefault();
      var key = $("input#yval_timeseries").val();
      var vals = [];
      $.ajax("/phila/_design/phila/_view/all_keys", {
        dataType: 'json',
        async: false,
        data: 'startkey=["'+key+'"]&endkey=["'+key+'",{}]',
        success: function(data) {
          var nans = false;
          for (i in data.rows) {
            var val = data.rows[i].value;
            if (!isNaN(val)) {
              var time = Date.parse(data.rows[i].key[1]);
              vals.push([time, val]);
            }
            else {
              nans = true;
            }
          }
          if (nans) {
            $("#timeseries_alert").fadeIn('slow');
          }
          else {
            $("#timseries_alert").fadeOut('slow');
          }
          $.plot($("#plot_timeseries"), [vals], {xaxis: {mode: "time"}});
        }
      });
    });

    // histogram
    $("button#makeplot_histogram").live('click', function(event) {
      event.preventDefault();
      var key = $("input#series_histogram").val();
      var nbins = $("input#nbins_histogram").val();
      var vals = [];
      $.ajax("/phila/_design/phila/_view/all_keys", {
        dataType: 'json',
        async: false,
        data: 'startkey=["'+key+'"]&endkey=["'+key+'",{}]',
        success: function(data) {
          var nans = false;
          for (i in data.rows) {
            var val = data.rows[i].value;
            if (!isNaN(val)) {
              var time = Date.parse(data.rows[i].key[1]);
              vals.push(val);
            }
            else {
              nans = true;
            }
          }
          if (nans) {
            $("#histogram_alert").fadeIn('slow');
          }
          else {
            $("#histogram_alert").fadeOut('slow');
          }
          var min = Math.min.apply(Math, vals);
          var max = Math.max.apply(Math, vals);
          var width = (max - min + 1) / nbins;

          var hist = histogram(vals, nbins);

          $.plot($("#plot_histogram"), [hist], {
            series: {
              stack: 0,
              lines: { show: false, fill: true, steps: false },
              bars: { show: true, barWidth: width }
            }
          });
        }
      });
    });

  </script>

</html>

