<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
    <title>Philadelphia / View Report</title>
    <script type="text/javascript" src="js/jquery-1.7.1.js"></script> 
    <script type="text/javascript" src="/_utils/script/jquery.couch.js?0.9.0"></script> 
    <script type="text/javascript" src="js/jquery.couchtools.js"></script>
    <script type="text/javascript" src="js/philly.render.js"></script>
    <link type="text/css" rel="stylesheet" href="css/bootstrap.css"/>
    <style>
      html, body {
        height: 100%;
      }
      #content {
        min-height: 100%;
        height: auto !important;
        height: 100%;
        margin: 0 auto -4em;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <!-- begin content //-->
    <div id="content">
      <div class="container-fluid">

        <div class="row-fluid">
          <!-- begin shift report //-->
          <div class="span10">
            <div class="row-fluid">
              <div class="span8">
                <h1>Shift Report</h1>
                <span class="label" id="report_id"></span>
              </div>
              <div class="span2" style="float:right">
                <div id="delete" style="float:right">
                  <a id="edit" class="btn" href="">Edit</a>
                  <a id="delete" class="btn btn-danger" data-toggle="modal" href="#delete-modal">Delete</a>
                </div>
              </div>
            </div>
            <hr>
            <div id="report" style="display:table;width:100%"></div>
          </div>
          <!-- end shift report //-->

          <!-- begin comments //-->
          <div id="comment-area" style="float:left;width:600px">
            <h2>Comments</h2>
            <div class="well" style="background:white">
              <div id="comments"></div>
              <div class="well">
                <h3>Add comment</h3>
                <form class="form-horizontal">
                  <fieldset>
                    <div class="control-group">
                      <div class="controls">
                        <textarea class="input-xlarge" name="text" id="comment-text" rows="5" cols="80"></textarea>
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="comment-name">Name</label>
                      <div class="controls">
                        <input type="text" class="input-xlarge" id="comment-name" name="name">
                      </div>
                    </div>
                    <div class="form-actions">
                      <input type="submit" value="Submit" id="comment-submit" class="btn btn-primary" style="float:right"/>
                    </div>
                  </fieldset>
                </form>
              </div>
            </div>
          </div>
          <!-- end comments //-->
        </div>

        <div id="footer"></div>
      </div>
    </div>
    <!-- end content //-->

    <!-- begin report delete modal //-->
    <div id="delete-modal" class="modal hide fade">
      <div class="modal-header">
        <a class="close" data-dismiss="modal">x</a>
        <h3>Confirm delete</h3>
      </div>
      <div class="modal-body">
        <p>Are you sure you wish to delete this shift report?</p>
      </div>
      <div class="modal-footer">
        <a href="#" onclick="removeDocs(doc_list); window.location.href='index.html'" class="btn btn-danger">Delete</a>
        <a href="#" data-dismiss="modal" class="btn">Cancel</a>
      </div>
    </div>
    <!-- end report delete modal //-->

  </body>

  <script>
    $('#header').load('header.html');
    $('#footer').load('footer.html');

    var doc_list = [getParameterByName('id')];
    var id = getParameterByName('id');

    var dbname = 'phila';
    $db = $.couch.db(dbname);

    $db.view("phila/report", {
      startkey: [id],
      endkey: [id, {}],
      success: function(data) {
        for (i in data.rows) {
          var doc = data.rows[i].value;
          var html ='<div style="background:white;color:black" class="well" id="' + doc._id + '"></div>';
          console.log(doc)
          $(html).appendTo('#report').couchtools('load', {
            db_name: dbname,
            doc_id: doc._id,
            actions: [renderers.block.view]
          });
        }
      }
    });

    $('#comments').couchtools('load', {
      db_name: dbname,
      doc_id: id,
      actions: [renderers.comments.view]
    });

    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regexS = "[\\?&]" + name + "=([^&#]*)";
      var regex = new RegExp(regexS);
      var results = regex.exec(window.location.href);
      if(results == null) return "";
      else return decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    function removeDocs(doc_list) {
      for (var i=0; i<doc_list.length; i++) {
        $.ajax('/' + dbname + '/' + doc_list[i], {
          dataType: 'json',
          async: false,
          success: function(data) {
            var id = doc_list[i];
            var rev = data._rev;
            $db.removeDoc({_id: id, _rev: rev}, {
              success: function() {
                //console.log('removed document ' + id);
              },
              error: function(status) {
                //alert('Unable to remove document ' + id + ', ' + status);
              }
            });
          },
          error: function(stat, msg) {
            //alert('Unable to open document ' + id + ' for removal, ' + msg);
          }
        });
      }
    }

    function setEditableState() {
      $db.openDoc(id, {
        success: function(data) {
          if (data.submitted == true) {
            $("a#edit").attr("disabled", "true");
            $("a#edit").attr('href', '#');
          }
        }
      });
    }

    $(document).ready(function() {
      $("span#report_id").html('DOCUMENT ID: ' + id);

      $("a#edit").attr('href', 'edit.html?id=' + id);
      setEditableState();

      $("#comment-submit").unbind('click').click(function(event) {
        event.stopPropagation();
        event.preventDefault();
        if ($("input#comment-name").val() == "" || $("textarea#comment-text").val() == "") {
          alert("Name and comment are required fields");
          return false;
        }
        $db.openDoc(id, {
          success: function(data) {
            var comment = {
              name: $("input#comment-name").val(),
              text: $("textarea#comment-text").val(),
              created: (new Date()).toString()
            };
            if ('comments' in data) {
              data.comments.push(comment);
            }
            else {
              data['comments'] = [comment];
            }
            $db.saveDoc(data, {
              success: function(data) {
                $('#comments').couchtools('load');
                $("textarea#comment-text").val('');
              },
              error: function() {
                alert('Failed to post comment');
              }
            });
          },
          error: function() {
            alert('Failed to post comment');
          }
        });
      });
    });
  </script>

</html>

