<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>Philadelphia :: View Report</title>
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.couch.js?0.9.0"></script> 
    <script type="text/javascript" src="js/jquery.boxy.js"></script> 
    <link type="text/css" rel="stylesheet" href="css/boxy.css">
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <link type="text/css" rel="stylesheet" href="css/jquery-ui-1.8.16.custom.css"/>
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Sans"/> 	
  </head>
  <body>
    <!-- begin header //-->
    <div id="header">
      <div id="branding">
        <a href="index.html" class="header"><h1 id="site-name">Philadelphia</h1></a>
      </div>
    </div>
    <br/>
    <!-- end header //-->

    <!-- begin content //-->
    <div id="content">

      <!-- begin shift report //-->
      <div style="float:left;width:73%;padding-left:10px">
        <div class="ui-widget-header" style="padding-bottom:6px">
          Shift Report
          <div id="delete" style="float:right;padding-top:-2px">
            <button type="button" id="delete" class="delete bad">Delete</button>
          </div>
          <div style="float:right;font-size:x-small;padding:7px" id="report_id"></div>
        </div>
        <div id="report" class="ui-widget-content" style="display:table;padding:0px;width:100%;background:#eee;color:black;"></div>
      </div>
      <!-- end shift report //-->

      <!-- begin footer //-->
      <div style="font-size:xx-small;float:right;padding-right:3em">
        <dl>
          <dt><b>Philadelphia,</b></dt>
          <dd><a href="https://github.com/mastbaum/philadelphia">Source on github</a></dd>
          <dd><a href="https://github.com/mastbaum/philadelphia/issues">Report a bug</a></dd>
          <dd>&nbsp;</dd>
          <dd><a href="mailto:mastbaum@hep.upenn.edu">Andy Mastbaum</a></dd>
          <dd>The University of Pennsylvania</dd>
        </dl>
      </div>
      <!-- end footer //-->


      <!-- begin comments //-->
      <div id="comment-area" style="float:left;width:50%;margin-left:10px;padding-top:10px">
        <div class="ui-widget-header">Comments</div>
        <div class="ui-widget-content" style="padding:0px;width:99.8%;background:#eee;color:black;">
          <div id="comments" style="width:95%"></div>
          <hr color="black" size="1" width="98%">
          <div style="background:white;color:black" class="ui-state-default item">
            <span class="template-name">Add comment</span>
            <form style="padding:10px">
              <textarea id="comment-text" rows="5" cols="80"></textarea><br/>
              Name: <input id="comment-name" type="text" name="name" value/>
              <input type="submit" value="Submit" id="comment-submit" style="border:solid 1px black"/>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- end comments //-->

  </div>
  <!-- end content //-->

  <!-- begin subdocument template //-->
  <div style="display:none;background:white;color:black" class="ui-state-default item" id="template">
    <span class="template-name"></span>
    <div class="docid" style="font-weight:normal;float:right;vertical-align:bottom"></div>
    <div class="timestamp"></div>
    <hr color="black" size="1">
    <div class="fields" style="display:table"></div>
  </div>
  <!-- end subdocument template //-->

</body>

<script>
  var doc_list = [getParameterByName('id')];
  var id = getParameterByName('id');

  function getParameterByName(name)
  {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.href);
    if(results == null)
    return "";
    else
    return decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  function loadComments() {
    $("#comments").empty();
    $db.view("phila/comments", {
      startkey: [id],
      endkey: [id, {}],
      success: function(data) {
        if (data.rows.length == 0) {
          $("#comments").html('<div style="display:block;background:white;color:black;width:100%" class="ui-state-default item">No comments</div>');
        }
        for (i in data.rows) {
          var d = (new Date(data.rows[i].value.created)).toString();
          var html = '<div style="display:block;background:white;color:black;width:100%" class="ui-state-default item">' +
            '<span style="float:left;padding-bottom:5px">' + data.rows[i].value.name + '</span>' +
            '<span style="float:right;font-size:small">' + d + '</span>' +
            '<hr size="1" color="black" width="98%">' +
            '<div style="display:table-cell">' + data.rows[i].value.text + '</div>' +
            '</div>';
          $("#comments").append(html);
        }
      },
      errors: function() {
        $("#comment-area").hide();
      }
    });
  }

  $(document).ready(function() {
    $db = $.couch.db("phila");
    $("div#report_id").html('Document ID: <span style="font-size:xx-small;color:#777">' + id.substring(0, id.length-8) + '</span>' + id.substring(id.length-8, id.length));

    loadComments();

    $("#comment-submit").unbind('click').click(function(event) {
      event.stopPropagation();
      event.preventDefault();
      if ($("input#comment-name").val() == "" || $("textarea#comment-text").val() == "") {
        alert("Name and comment are required fields");
        return false;
      }
      $db.openDoc(id, {
        success: function(data) {
          var comment = {
            name: $("input#comment-name").val(),
            text: $("textarea#comment-text").val(),
            created: (new Date()).toString()
          };
          if ('comments' in data) {
            data.comments.push(comment);
          }
          else {
            data['comments'] = [comment];
          }
          $db.saveDoc(data, {
            success: function(data) {
              loadComments();
              $("textarea#comment-text").val('');
            },
            error: function() {
              alert('Failed to post comment');
            }
          });
        },
        error: function() {
          alert('Failed to post comment');
        }
      });
    });

    $db.view("phila/report", {
      startkey: [id],
      endkey: [id, {}],
      success: function(data) {
        for (i in data.rows) {
          var id = data.rows[i].value._id;
          var subtype = data.rows[i].value.subtype;
          var subtype_name = data.rows[i].value.subtype_name;
          var d = new Date(data.rows[i].value.created);
          var created = d.toLocaleString();
          $("div#report").append($("div#template").clone().css("display", "block").attr("id",id));
          $("div#"+id+" > span.template-name").html(subtype_name);
          $("div#"+id+" > div.timestamp").html('Created: ' + created);
          $("div#"+id+" > div.docid").html('Document ID: ' + id);
          var jrow = 0;
          var meta_fields = {'subtype':'','report_id':'','_rev':'','type':'','_id':'','created':'','_attachments':'', 'subtype_name': ''}
          for (field in data.rows[i].value) {
            //console.log(data.rows[i].value);
            if (field in meta_fields)
            continue;

            html = '<div style="display:table-row;width:100%">' +
              '<div style="white-space:nowrap;color:black;display:table-cell;padding:3px;background:' + (jrow%2?'#d6e6d6':'#f1f1f1') + '">' + field + '</div>' +
              '<div style="color:black;width:100%;display:table-cell;padding:3px;font-weight:normal;background:' + (jrow%2?'#dceede':'#fafafa') + '">' + data.rows[i].value[field].replace(/\n/gi,'<br/>') + '</div>' +
              '</div>';
            $("div#"+id).append(html);
            jrow++;
          }

          for (file in data.rows[i].value._attachments) {
            html = '<div style="display:table-row;width:100%">' +
              '<div style="white-space:nowrap;color:black;display:table-cell;padding:3px;background:' + (jrow%2?'#d6e6d6':'#f1f1f1') + '">Attachment: </div>' +
              '<div style="color:black;width:auto;display:table-cell;padding:3px;font-weight:normal;background:' + (jrow%2?'#dceede':'#fafafa') + '"><a style="color:black;text-decoration:underline" target="_new" href="/phila/' + data.rows[i].value._id + '/' +file+'">'+file+'</a></div>' +
              '</div>';
            $("div#"+id).append(html);
            jrow++;
          }
          doc_list.push(id);
        }
      }
    });
  });

  $("button#delete").live('click', function(event) {
    Boxy.confirm("Are you sure you wish to delete this shift report?", function() {
      //console.log('remove all associated docs');
      removeAllDocs();
      return false;  
    }, {title: 'Delete'});
  });

  function removeAllDocs() {
    //console.log('removing all associated docs');
    for (var i=0; i<doc_list.length; i++) {
      $.ajax('/phila/' + doc_list[i], {
        dataType: 'json',
        async: false,
        success: function(data) {
          var id = doc_list[i];
          var rev = data._rev;
          $db.removeDoc({_id: id, _rev: rev}, {
            success: function() {
              //console.log('removed document ' + id);
              window.location.href = 'index.html';
            },
            error: function(status) {
              alert('Unable to remove document ' + id + ', ' + status);
            }
          });
        },
        error: function() {
          alert('Unable to open document ' + id + ' for removal');
        }
      });
    }
  }
</script>

</html>

